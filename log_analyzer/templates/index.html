{% extends "base.html" %}

{% block title %}Log Analyzer - Dashboard{% endblock %}

{% block content %}
<h3>日志文件分析</h3>
<p>Upload one or more log files for analysis</p>

<div class="upload-container">
    <form id="uploadForm">
        <input type="file" name="files" id="fileInput" multiple accept=".log,.txt">
        <div id="fileList" class="file-list"></div>

        <div id="overallProgress" class="overall-progress" style="display: none;">
            <h3>Overall Progress</h3>
            <div class="progress-container">
                <div id="totalProgressBar" class="progress-bar">0%</div>
            </div>
            <div id="totalStatus" class="file-status">Preparing upload...</div>
        </div>

        <div id="uploadStatus" class="upload-status"></div>

        <button type="button" id="uploadBtn" class="btn" disabled>Upload & Analyze</button>
    </form>
    <div id="parseProgressContainer" class="parse-progress-container" style="display: none;">
        <h3>日志文件解析进度</h3>
        <div class="progress-container">
            <div id="parseProgressBar" class="progress-bar">0%</div>
        </div>
        <div id="parseStatus" class="parse-status">准备解析...</div>
        <div id="fileDetails" class="file-details"></div>
    </div>
</div>
<h3>Or use the API:</h3>
<pre>
        POST /api/analyze
        Content-Type: multipart/form-data

        Send log files as 'files' parameter (multiple files allowed)
    </pre>
<div class="container py-8">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-folder-open me-2"></i>历史报告</h3>
        <div class="d-flex">
            <input type="text" id="searchInput" class="form-control me-3" placeholder="搜索报告...">
            <select id="filterType" class="form-select" style="width: 120px;">
                <option value="all">所有类型</option>
                <option value="HTML">HTML</option>
                <option value="PDF">PDF</option>
                <option value="DOC">DOC</option>
                <option value="XLS">XLS</option>
            </select>
        </div>
        <div class="col-md-3">
            <button id="cleanupBtn" class="btn btn-sm btn-outline-primary">
                清理报告
            </button>
            <button id="showHistoryBtn" class="btn btn-sm btn-outline-primary">查看记录</button>
        </div>
    </div>

    <!-- 结果提示框 -->
    <div id="cleanupResult" class="alert mt-3" style="display: none;">
        <button type="button" onclick="this.closest('.alert').style.display='none'"
                class="close absolute top-2 right-2 flex items-center justify-center w-8 h-8 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <span aria-hidden="true" class="text-xl font-bold">&times;</span>
          <span class="sr-only">Close alert</span>
        </button>

        <span id="cleanupMessage"></span>
    </div>

    <!-- 报告统计信息 -->
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i>
        共 {{ total_reports }} 份报告，当前显示第 {{ ((page - 1) * config.REPORTS_PER_PAGE) + 1 }}
        至 {{ [page * config.REPORTS_PER_PAGE, total_reports]|min }} 条
    </div>

    <!-- 历史记录弹窗 -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <div class="row fw-bold">
                <div class="col-md-4">报告名称</div>
                <div class="col-md-1">类型</div>
                <div class="col-md-2">日期</div>
                <div class="col-md-2">大小</div>
                <div class="col-md-2">操作</div>
                <div class="col-md-1">操作</div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="list-group list-group-flush" id="reportList">
                {% if reports %}
                {% for report in reports %}
                <div class="list-group-item report-item" data-type="{{ report.type }}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <i class="fas {{ report.icon }} me-1 text-primary"></i>
                            <span class="report-name">{{ report.display_name }}</span>
                        </div>
                        <div class="col-md-1">
                            <span class="badge bg-secondary">{{ report.type }}</span>
                        </div>
                        <div class="col-md-2">{{ report.date }}</div>
                        <div class="col-md-2">{{ report.size }}</div>
                        <div class="col-md-2">
                            <a href="#"
                               class="btn btn-sm btn-outline-primary preview-btn"
                               data-filename="{{ report.filename }}"
                               data-bs-toggle="tooltip"
                               title="预览报告">
                                <i class="fas fa-eye"></i>
                            </a>
                            <!-- 修改为在新窗口打开 -->
                            <a href="{{ url_for('serve_report', filename=report.filename, deviceID=deviceID) }}"
                               class="btn btn-sm btn-outline-primary"
                               target="_blank"
                               data-bs-toggle="tooltip"
                               title="下载报告">
                                <i class="fas fa-eye-slash"></i>
                            </a>
                        </div>
                        <div class="col-md-1">
                            <a href="#"
                               class="btn btn-sm btn-outline-danger delete-btn"
                               data-filename="{{ report.filename }}"
                               title="删除报告">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="list-group-item text-center py-5 text-muted">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p class="mb-0">没有找到任何历史报告</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- 结果提示 -->
    <div id="deleteResult" class="alert" style="display: none;"></div>
    <!-- 分页导航 -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-6">
        <ul class="pagination justify-content-center">
            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page=1" aria-label="First">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page - 1 }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}

            {# 显示当前页附近的页码 #}
            {% set start_page = [1, page - 2]|max %}
            {% set end_page = [total_pages, page + 2]|min %}

            {% if start_page > 1 %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% endif %}

            {% for p in range(start_page, end_page + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}">{{ p }}</a>
            </li>
            {% endfor %}

            {% if end_page < total_pages %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% endif %}

            {% if page < total_pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page + 1 }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ total_pages }}" aria-label="Last">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
            {% endif %}
            <!-- 添加跳转页码输入框 - 改进版本 -->
            <div class="d-flex justify-content-center mt-3 align-items-center" style="margin-left: 200px;">
                <div class="input-group" style="width: 220px;">
                    <input type="number"
                           id="pageJump"
                           class="form-control form-control-sm text-center"
                           min="1"
                           max="{{ total_pages }}"
                           value="{{ page }}"
                           onkeypress="handlePageJumpKeyPress(event)"
                           style="height: 31px;">
                    <button class="btn btn-outline-primary btn-sm btn-jumpToPage" onclick="jumpToPage()" >
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <span class="ms-2 text-muted small">
                    共 {{ total_pages }} 页
                    </span>
                </div>

            </div>
        </ul>

    </nav>
    {% endif %}
    <!-- 每页显示数量选择 -->
    <div class="d-flex align-items-center">
        <span class="me-2">每页显示:</span>
        <select id="perPageSelect" class="form-select form-select-sm" style="width: 100px;">
            <option value="5" {% if per_page== 5 %}selected{% endif %}>5条</option>
            <option value="10" {% if per_page== 10 %}selected{% endif %}>10条</option>
            <option value="20" {% if per_page== 20 %}selected{% endif %}>20条</option>
            <option value="50" {% if per_page== 50 %}selected{% endif %}>50条</option>
            <option value="100" {% if per_page== 100 %}selected{% endif %}>100条</option>
        </select>
    </div>
</div>

<!-- Bootstrap 历史记录模态框 -->
<div class="modal fade" id="historyModal" aria-hidden="true">
    <div id="historyContent">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">历史解析记录</h5>
                <button type="button" class="btn-close" id="closeHistoryBtn" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="historyList" class="list-group mb-3">
                    <!-- 动态加载历史记录 -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 预览模态框 -->
<div class="modal fade" id="previewModal" aria-hidden="true" tabindex="-1">
    <div id="previewhistoryContent">
        <div class="modal-content">
            <div class="modal-header">
                <h7 class="modal-title">解析结果预览</h7>
                <button type="button" class="btn-close" id="closepreviewModal" aria-label="Close"></button>
            </div>
            <div class="previewhistorymodalbody">
                <h6 id="previewTitle" class="mb-3"></h6>
                <!-- 搜索和过滤控制区 -->
                <div class="d-flex justify-content-between mb-10">
                    <!-- 搜索框 -->
                    <div class="w-50">
                        <div class="input-group search-group">
                            <input type="text" class="form-control" id="logSearchInput" placeholder="搜索日志内容...">
                            <button class="btn btn-sm btn-outline-primary align-btn" type="button" id="clearSearchBtn">
                                <i class="bi bi-x-lg"></i> 清理
                            </button>

                            <button class="btn btn-sm btn-outline-primary align-btn" type="button" id="searchLogsBtn">
                                <i class="bi bi-search"></i> 搜索
                            </button>
                        </div>
                    </div>
                    <!-- Filter Controls -->
                    <div class="filter-controls mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="showWarnings" checked>
                            <label class="form-check-label" for="showWarnings">
                                Warnings (Total: <span id="totalWarnings">0</span>)
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="showErrors" checked>
                            <label class="form-check-label" for="showErrors">
                                Errors (Total: <span id="totalErrors">0</span>)
                            </label>
                        </div>
                        <button type="button" id="showHistoryDetailBtn" class="btn btn-sm btn-outline-primary"
                                style="margin-bottom: 20px;">查看详情
                        </button>
                    </div>
                </div>
                <!-- 搜索结果统计 -->
                <div class="alert alert-info py-2 mb-3 d-none" id="searchResultsInfo">
                    找到 <span id="matchesCount">0</span> 条匹配结果
                    <button type="button" class="btn-close float-end" id="closeSearchResults"></button>
                </div>
                <!-- Preview Content -->
                <div id="previewContent">

                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
<!-- 报告预览模态框 -->
<div class="modal fade" id="reportPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div id="reportPreviewModalBody">
                <!-- 动态内容将在这里加载 -->
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
    <!-- JavaScript Libraries -->
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sweetalert2@11') }}"></script>
<script>
    // 文件列表和上传状态
    let selectedFiles = [];
    let interval;
    const X_Device_ID = getDeviceId()
    // 在上传请求头中添加设备ID
    const headers = {
        'X-Device-ID': X_Device_ID  // 你的获取设备ID逻辑
    };
    // 分页配置
    const paginationConfig = {
        pageSize: 5000,
        currentPage: 1
    };
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadBtn');
    const overallProgress = document.getElementById('overallProgress');
    const totalProgressBar = document.getElementById('totalProgressBar');
    const totalStatus = document.getElementById('totalStatus');
    const uploadStatus = document.getElementById('uploadStatus');
    const cleanupBtn = document.getElementById('cleanupBtn');
    const pageJump = document.getElementById('pageJump');

    document.getElementById("showHistoryBtn").addEventListener("click", loadHistory);

    // 搜索功能实现
    document.getElementById('searchLogsBtn').addEventListener('click', searchLogs);
    document.getElementById('logSearchInput').addEventListener('keyup', function (e) {
        if (e.key === 'Enter') searchLogs();
    });

    let currentSearchTerm = '';
    let currentMatches = [];

    function getBrowserFingerprint() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillStyle = '#f60';
        ctx.fillRect(125, 1, 62, 20);
        ctx.fillStyle = '#069';
        ctx.fillText('BrowserFingerprint', 2, 15);
        ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
        ctx.fillText('BrowserFingerprint', 4, 17);

        return canvas.toDataURL();
    }

    function getDeviceId() {
        const fingerprint = getBrowserFingerprint();
        return hashString(fingerprint); // 对指纹进行哈希处理
    }

    function hashString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash = hash & hash; // Convert to 32bit integer
        }
        return hash.toString();
    }


    function searchLogs() {
        const searchTerm = document.getElementById('logSearchInput').value.trim();
        if (!searchTerm) {
            clearSearch();
            return;
        }

        currentSearchTerm = searchTerm.toLowerCase();
        currentMatches = [];

        // 搜索所有日志行
        const errorRows = document.querySelectorAll('#errorTableBody tr');
        const exceptionRows = document.querySelectorAll('#exceptionTableBody tr');

        // 搜索错误表
        errorRows.forEach((row, index) => {
            const message = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const source = row.querySelector('td:nth-child(3)').textContent.toLowerCase();

            if (message.includes(currentSearchTerm) || source.includes(currentSearchTerm)) {
                currentMatches.push({
                    type: 'error',
                    element: row,
                    index: index
                });
                highlightText(row, currentSearchTerm);
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // 搜索异常表
        exceptionRows.forEach((row, index) => {
            const type = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
            const message = row.querySelector('td:nth-child(3)').textContent.toLowerCase();

            if (type.includes(currentSearchTerm) || message.includes(currentSearchTerm)) {
                currentMatches.push({
                    type: 'exception',
                    element: row,
                    index: index
                });
                highlightText(row, currentSearchTerm);
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // 显示搜索结果信息
        const resultsInfo = document.getElementById('searchResultsInfo');
        document.getElementById('matchesCount').textContent = currentMatches.length;
        resultsInfo.classList.remove('d-none');

        // 如果没有结果，显示提示
        if (currentMatches.length === 0) {
            resultsInfo.classList.add('alert-warning');
            resultsInfo.classList.remove('alert-info');
            resultsInfo.innerHTML = `没有找到匹配 "${searchTerm}" 的结果
                    <button type="button" class="btn-close float-end" id="closeSearchResults"></button>`;
        } else {
            resultsInfo.classList.add('alert-info');
            resultsInfo.classList.remove('alert-warning');
        }

        // 添加关闭搜索结果事件
        document.getElementById('closeSearchResults').addEventListener('click', clearSearch);
    }

    function highlightText(row, searchTerm) {
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
            const text = cell.textContent;
            const regex = new RegExp(searchTerm, 'gi');
            const highlightedText = text.replace(regex, match =>
                `<span class="bg-warning text-dark">${match}</span>`);
            cell.innerHTML = highlightedText;
        });
    }

    function clearSearch() {
        currentSearchTerm = '';
        document.getElementById('logSearchInput').value = '';
        document.getElementById('searchResultsInfo').classList.add('d-none');

        // 显示所有行并移除高亮
        document.querySelectorAll('#errorTableBody tr, #exceptionTableBody tr').forEach(row => {
            row.style.display = '';
            row.querySelectorAll('td').forEach(td => {
                if (td.innerHTML.includes('<span class="bg-warning text-dark">')) {
                    td.innerHTML = td.textContent;
                }
            });
        });

        // 重置过滤
        applyFilters();
    }

    // 清除搜索按钮
    document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);

    // 实时搜索和过滤功能
    document.getElementById('searchInput').addEventListener('input', filterReports);
    document.getElementById('filterType').addEventListener('change', filterReports);

    // 文件选择处理
    fileInput.addEventListener('change', function (e) {
        selectedFiles = Array.from(this.files);
        renderFileList();

        uploadBtn.disabled = selectedFiles.length === 0;
    });

    // 渲染文件列表
    function renderFileList() {
        fileList.innerHTML = '';

        if (selectedFiles.length > 0) {
            const header = document.createElement('div');
            header.style.fontWeight = 'bold';
            header.textContent = `Selected ${selectedFiles.length} file(s):`;
            fileList.appendChild(header);

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.id = `file-${index}`;

                fileItem.innerHTML = `
                            <div class="file-header">
                                <span class="file-name">${file.name}</span>
                                <span class="file-size">${formatFileSize(file.size)}</span>
                            </div>
                            <div class="progress-container">
                                <div id="progress-${index}" class="progress-bar">0%</div>
                            </div>
                            <div id="status-${index}" class="file-status">Waiting to upload</div>
                        `;

                fileList.appendChild(fileItem);
            });
        }
    }

    // ================ UI更新函数 ================

    function setUploadingState(isUploading) {
        uploadBtn.disabled = isUploading;
        uploadBtn.textContent = isUploading ? '上传中...' : '开始上传';
        overallProgress.style.display = isUploading ? 'block' : 'none';
    }

    function resetAllProgressBars() {
        selectedFiles.forEach((_, index) => {
            updateFileProgress(index, 0);
            updateFileStatus(index, '', '等待上传');
        });
        totalProgressBar.style.width = '0%';
        totalProgressBar.textContent = '0%';
        totalStatus.textContent = '准备上传';
    }

    function updateFileProgress(fileIndex, percent) {
        const progressBar = document.getElementById(`progress-${fileIndex}`);
        progressBar.style.width = `${percent}%`;
        progressBar.textContent = `${percent}%`;
    }

    function updateFileStatus(fileIndex, statusClass, message) {
        const statusElement = document.getElementById(`status-${fileIndex}`);
        statusElement.textContent = message;
        statusElement.className = `file-status ${statusClass}`;
    }

    function updateOverallProgress() {
        const totalUploaded = selectedFiles.reduce((sum, file, index) => {
            const progress = document.getElementById(`progress-${index}`).style.width;
            return sum + (parseInt(progress) || 0) * file.size / 100;
        }, 0);

        const totalBytes = selectedFiles.reduce((sum, file) => sum + file.size, 0);
        const totalPercent = Math.round((totalUploaded / totalBytes) * 100);

        totalProgressBar.style.width = `${totalPercent}%`;
        totalProgressBar.textContent = `${totalPercent}%`;
        totalStatus.textContent = `上传中: ${totalPercent}% (${formatFileSize(totalUploaded)} / ${formatFileSize(totalBytes)})`;
    }

    function showStatusMessage(message, type = 'info') {
        uploadStatus.textContent = message;
        uploadStatus.className = `upload-status ${type}`;
    }

    // ================ 辅助函数 ================

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // 添加轮询函数
    // 修改pollParseProgress函数
    function pollParseProgress(batchId) {
        interval = setInterval(async () => {
            try {
                const response = await fetch(`/api/parse-progress/${batchId}`, {
                    headers: {
                        'X-Device-ID': getDeviceId()
                    }
                });
                const data = await response.json();

                if (data.status === 'success') {
                    // Update overall progress
                    const progress = Math.round(data.progress);
                    const progressBar = document.getElementById('parseProgressBar');
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${progress}%`;

                    // Update status text
                    document.getElementById('parseStatus').textContent =
                        `正在解析: ${progress}% (${data.processed_files}/${data.total_files})`;

                    // Update file details with per-file progress
                    let fileDetailsHtml = '';
                    if (data.files && data.files.length > 0) {
                        fileDetailsHtml = '<div class="file-progress-container">';
                        data.files.forEach(file => {
                            fileDetailsHtml += `
                                <div class="file-progress-item">
                                    <div class="file-name">${file.filename}</div>
                                    <div class="progress-container">
                                        <div class="progress-bar" style="width: ${file.progress}%">
                                            ${file.progress}%
                                        </div>
                                    </div>
                                    <div class="file-status">${file.status}</div>
                                </div>
                            `;
                        });
                        fileDetailsHtml += '</div>';
                    }
                    document.getElementById('fileDetails').innerHTML = fileDetailsHtml;

                    // Check if completed
                    if (data.batch_status === 'completed') {
                        clearInterval(interval);
                        document.getElementById('parseStatus').textContent = '解析完成! 准备结果...';

                        // Redirect to results page after delay
                        setTimeout(() => {
                            const deviceId = getDeviceId();
                            const form = document.createElement('form');
                            form.action = '/index';
                            form.method = 'GET';

                            const deviceIdInput = document.createElement('input');
                            deviceIdInput.type = 'hidden';
                            deviceIdInput.name = 'device_id';
                            deviceIdInput.value = deviceId;

                            const batchIdInput = document.createElement('input');
                            batchIdInput.type = 'hidden';
                            batchIdInput.name = 'batch_id';
                            batchIdInput.value = batchId;

                            form.appendChild(deviceIdInput);
                            form.appendChild(batchIdInput);
                            document.body.appendChild(form);
                            form.submit();
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('获取解析进度失败:', error);
                clearInterval(interval);
                document.getElementById('parseStatus').textContent = '解析进度获取失败';
            }
        }, 2000);
    }

    async function submitFormAndGetResponse(formData) {
        try {
            const response = await fetch('/results', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                clearInterval(interval);
                setUploadingState(false);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json(); // 假设返回 JSON
            console.log("Server response:", result);
            return result;
        } catch (error) {
            console.error("Error submitting form:", error);
            showStatusMessage(error);
            setUploadingState(false);
            throw error;
        }
    }

    // 上传按钮点击事件
    uploadBtn.addEventListener('click', async function () {
        if (selectedFiles.length === 0) {
            showStatusMessage('请先选择文件', 'error');
            return;
        }
        // 初始化上传状态
        setUploadingState(true);
        resetAllProgressBars();
        try {
            // 创建批量上传任务
            const config = await fetch('/get_upload_config/' + X_Device_ID, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Device-ID': X_Device_ID,  // 你的获取设备ID逻辑
                        }
                    });
            const data = await config.json();
            const CHUNK_SIZE = data.chunk_size;  // 使用后端返回的分片大小
            const uploadResults = await batchUploadFiles(selectedFiles, chunkSize=CHUNK_SIZE);

            // 处理上传结果
            if (uploadResults.every(result => result.success)) {
                showStatusMessage('所有文件上传成功! 正在分析...', 'success');
                await delay(2500); // 给用户时间看到成功消息
                // 跳转前可以添加一个检查接口
                try {
                    const response = await fetch('/batch-check-uploads', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Device-ID': X_Device_ID,  // 你的获取设备ID逻辑
                        },
                        body: JSON.stringify({
                            file_ids: uploadResults.map(f => f.fileId)
                        })
                    });
                    const data = await response.json();
                     // 验证每个文件状态
                    const allCompleted = Object.values(data).every(item =>
                        item.status === 'completed'
                    );
                    if (allCompleted) {
                        const deviceId = getDeviceId();
                        // 获取所有文件的batch_id (应该相同)
                        const batchIds = uploadResults.map(r => r.batchId).filter(id => id);
                        // 使用第一个有效的batch_id开始轮询
                        const batchId = batchIds[0];
                        //window.location.href = `/results?device_id=${encodeURIComponent(deviceId)}`;
                        // 不进行跳转
                        // 使用POST请求替代GET跳转
                        const formData = new FormData();
                        formData.append('device_id', deviceId);
                        formData.append('batch_id', batchId);
                        formData.append('file_ids', JSON.stringify({
                                file_ids: uploadResults.map(f => f.fileId)  // 确保这里返回的是数组
                            }));
                        // form.submit();
                       submitFormAndGetResponse(formData)

                        if (batchIds.length > 0) {
                            // 显示解析进度容器
                            document.getElementById('parseProgressContainer').style.display = 'block';

                            pollParseProgress(batchId);
                        } else {
                            showStatusMessage('无法获取解析批次ID', 'error');
                        }
                    } else {
                        console.log('存在未完成的文件:', data);
                        // 可选：显示详细的文件状态信息
                        showStatusMessage(data);
                    }
                } catch (error) {
                    showStatusMessage(`分析准备失败: ${error.message}`, 'error');
                    setUploadingState(false);
                }
            } else {
                const failedFiles = uploadResults.filter(r => !r.success);
                showStatusMessage(`${failedFiles.length}个文件上传失败`, 'error');
                setUploadingState(false);
            }
        } catch (error) {
            console.error('上传过程中出错:', error);
            showStatusMessage('上传过程中发生错误', 'error');
            setUploadingState(false);
        }
    });

    // ================ 工具函数 ================
    function generateUUID() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }
    /**
     * 批量上传文件 (分块并行上传)
     */
    async function batchUploadFiles(files, chunkSize) { // 默认5MB分块
        const results = [];
        const uploadQueue = [];
        let currentBatchId = generateUUID();

        // 创建并行上传任务
        files.forEach((file, fileIndex) => {
            uploadQueue.push(
                uploadFileWithProgress(file, fileIndex, chunkSize, currentBatchId)
                    .then(result => {
                        results[fileIndex] = result;
                        updateFileStatus(fileIndex, 'success', '上传完成');
                    })
                    .catch(error => {
                        results[fileIndex] = {
                            success: false,
                            file: file.name,
                            error: error.message
                        };
                        updateFileStatus(fileIndex, 'error', '上传失败');
                    })
            );
        });

        await Promise.all(uploadQueue);
        return results;
    }

    /**
     * 带进度显示的文件上传
     */
    async function uploadFileWithProgress(file, fileIndex, chunkSize, currentBatchId) {
        const fileId = `${Date.now()}-${fileIndex}`;
        let uploadedSize = 0;
        let batchId = currentBatchId;  // 存储返回的batch_id


        // 文件分块处理
        for (let chunkIndex = 0; chunkIndex < file.size; chunkIndex += chunkSize) {
            const end = Math.min(chunkIndex + chunkSize, file.size);
            const chunk = file.slice(chunkIndex, end);

            const formData = new FormData();
            formData.append('fileId', fileId);
            formData.append('chunkIndex', Math.floor(chunkIndex / chunkSize));
            formData.append('totalChunks', Math.ceil(file.size / chunkSize));
            formData.append('file', chunk);
            formData.append('batchId', currentBatchId);
            formData.append('fileName', file.name);
            formData.append('fileSize', file.size);

            try {
                const response = await fetchWithProgress('/upload-chunk', {
                    method: 'POST',
                    body: formData,
                    headers: {  // 添加headers
                        'X-Device-ID': X_Device_ID,
                        // 可以添加其他需要的headers
                    },
                    fileIndex,
                    onProgress: (loaded, total) => {
                        uploadedSize = chunkIndex + loaded;
                        const percent = Math.round((uploadedSize / file.size) * 100);
                        updateFileProgress(fileIndex, percent);
                        updateOverallProgress();
                    }
                });

                // 检查响应状态
                const data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.message || '上传失败');
                }
                // 如果是最后一个分块，保存返回的batch_id
                if (chunkIndex + chunkSize >= file.size && data.batch_id) {
                    batchId = data.batch_id;
                }
            } catch (error) {
                // 根据错误类型决定是否重试
                if (error.message.includes('大小超过限制')) {
                    throw new Error('请减小分块大小后重试');
                } else if (error.message.includes('分块不完整')) {
                    throw new Error('请重新上传缺失的分块');
                } else {
                    // 网络错误等可重试错误
                    console.error(`分块 ${chunkIndex} 上传失败:`, error);
                    throw new Error(`分块 ${chunkIndex + 1}/${totalChunks} 上传失败: ${error.message}`);
                }
            }
        }

        return {success: true, file: file.name, fileId: fileId, batchId: batchId};
    }

    /**
     * 带进度回调的fetch封装
     */
    function fetchWithProgress(url, {method, body, headers, fileIndex, onProgress}) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();

            xhr.open(method, url, true);

            // 设置请求头
            if (headers) {
                Object.entries(headers).forEach(([key, value]) => {
                    xhr.setRequestHeader(key, value);
                });
            }

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable && onProgress) {
                    onProgress(e.loaded, e.total);
                }
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        // 解析JSON响应
                        const response = JSON.parse(xhr.responseText);
                        resolve({
                            ok: true,
                            status: xhr.status,
                            json: async () => response,
                            text: async () => xhr.responseText
                        });
                    } catch (e) {
                        reject(new Error('Invalid JSON response'));
                    }
                } else {
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        reject(new Error(errorResponse.message || xhr.statusText));
                    } catch {
                        reject(new Error(xhr.statusText));
                    }
                }
            };

            xhr.onerror = () => reject(new Error('Network error'));
            xhr.onabort = () => reject(new Error('Upload aborted'));

            xhr.send(body);
        });
    }

    // 获取当前正在上传的文件索引
    function getCurrentFileIndex(loadedBytes, fileProgress, files) {
        let accumulated = 0;
        for (let i = 0; i < files.length; i++) {
            accumulated += files[i].size;
            if (loadedBytes <= accumulated) {
                // 更新文件进度
                fileProgress[i] = loadedBytes - (accumulated - files[i].size);
                return i;
            }
        }
        return -1;
    }

    // 处理上传错误
    function handleUploadError(message) {
        uploadStatus.textContent = message;
        uploadStatus.className = 'upload-status error-status';
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Try Again';

        // 标记所有文件为错误状态
        selectedFiles.forEach((_, index) => {
            document.getElementById(`status-${index}`).textContent = 'Upload failed';
            document.getElementById(`status-${index}`).className = 'file-status error-status';
        });

        totalStatus.textContent = 'Upload failed: ' + message;
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 实时搜索和过滤功能
    document.getElementById('searchInput').addEventListener('input', filterReports);
    document.getElementById('filterType').addEventListener('change', filterReports);

    function filterReports() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const filterType = document.getElementById('filterType').value;
        const items = document.getElementsByClassName('report-item');

        for (let item of items) {
            const name = item.querySelector('.report-name').textContent.toLowerCase();
            const type = item.getAttribute('data-type');

            const nameMatch = name.includes(searchText);
            const typeMatch = filterType === 'all' || type === filterType;

            if (nameMatch && typeMatch) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        }
    }


    cleanupBtn.addEventListener('click', function () {
        // 显示加载状态
        const btn = this;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 清理中...';
        btn.disabled = true;

        // 发送AJAX请求
        fetch("{{ url_for('cleanup_uploads') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Device-ID': X_Device_ID,
            }
        })
            .then(response => response.json())
            .then(data => {
                // 显示结果
                const resultDiv = document.getElementById('cleanupResult');
                resultDiv.style.display = 'block';

                if (data.status === 'success') {
                    resultDiv.className = 'alert alert-success mt-3';
                    showcleanupResultMessage(`
                            <i class="fas fa-check-circle"></i> ${data.message}
                            ${data.deleted_files.length > 0 ?
                        '<br>已删除文件: ' + data.deleted_files.join(', ') : ''}
                        `) ;
                } else {
                    resultDiv.className = 'alert alert-danger mt-3';
                    showcleanupResultMessage(`<i class="fas fa-exclamation-circle"></i> ${data.message}`);
                }
            })
            .catch(error => {
                showcleanupResultMessage(
                    `<i class="fas fa-exclamation-circle"></i> 请求失败: ${error}`);
            })
            .finally(() => {
                // 恢复按钮状态
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            });
    });

    function showcleanupResultMessage(message, type = 'info') {
        const alertBox = document.getElementById('cleanupResult');
        const messageSpan = document.getElementById('cleanupMessage');

        // 设置消息内容
        messageSpan.innerHTML = message;

        // 设置消息类型样式
        alertBox.className = 'alert mt-3'; // 重置所有类
        alertBox.classList.add('alert-' + type); // 添加类型类

        // 显示提示框
        alertBox.style.display = 'block';

        // 设置自动隐藏计时器
        let timer = alertBox.getAttribute('data-timer');
        if (timer) clearTimeout(timer);

        timer = setTimeout(() => {
            alertBox.style.display = 'none';
        }, 5000); // 5秒后自动隐藏

        alertBox.setAttribute('data-timer', timer);
    }


    document.addEventListener('DOMContentLoaded', function () {
        // 删除按钮事件处理
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault(); // 阻止默认行为

                const filename = this.getAttribute('data-filename');
                const listItem = this.closest('.list-group-item');

                // 使用SweetAlert2进行确认提示
                Swal.fire({
                    title: '确认删除?',
                    text: `您确定要删除 "${filename}" 吗？此操作不可撤销！`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: '确认删除',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // 显示加载状态
                        const originalHtml = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        this.disabled = true;

                        // 发送AJAX删除请求
                        fetch("{{ url_for('delete_file') }}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-Device-ID': X_Device_ID,
                            },
                            body: JSON.stringify({filename: filename})
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    // 从DOM中移除被删除的项目
                                    listItem.remove();

                                    // 显示成功提示
                                    Swal.fire(
                                        '已删除!',
                                        data.message,
                                        'success'
                                    );

                                    // 如果没有报告了，显示空状态
                                    if (document.querySelectorAll('.report-item').length === 0) {
                                        document.getElementById('reportList').innerHTML = `
                                                <div class="list-group-item text-center py-5 text-muted">
                                                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                                                    <p class="mb-0">没有找到任何历史报告</p>
                                                </div>
                                            `;
                                    }
                                } else {
                                    Swal.fire(
                                        '删除失败!',
                                        data.message,
                                        'error'
                                    );
                                }
                            })
                            .catch(error => {
                                Swal.fire(
                                    '错误!',
                                    '删除请求失败: ' + error,
                                    'error'
                                );
                            })
                            .finally(() => {
                                this.innerHTML = originalHtml;
                                this.disabled = false;
                            });
                    }
                });
            });
        });
    });

    document.querySelectorAll('.preview-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const filename = this.getAttribute('data-filename');
            const modal = new bootstrap.Modal(document.getElementById('reportPreviewModal'));

            // 显示加载状态
            const modalBody = document.getElementById('reportPreviewModalBody');
            modalBody.innerHTML = `
                        <div class="modal-header">
                            <h5 class="modal-title">加载报告预览</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-3">正在准备报告预览...</p>
                        </div>
                    `;
            modal.show();

            // 更健壮的fetch处理
            fetch(`{{ url_for('preview_report', filename='') }}${filename}`, {
                    method: 'GET', // 或 'POST' 等
                    headers: {
                        'Content-Type': 'application/json', // 可选
                        'X-Device-ID': X_Device_ID,      // 添加设备ID头
                    },
                })
                .then(response => {
                    // 首先检查响应状态
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态码: ${response.status}`);
                    }

                    // 检查Content-Type
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error("无效的响应格式");
                    }

                    return response.json();
                })
                .then(data => {
                    if (data.status === 'oversize') {
                        // 处理大文件情况
                        modalBody.innerHTML = `
                                    <div class="modal-header">
                                        <h5 class="modal-title">文件过大</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body text-center py-4">
                                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                                        <h5>${data.message}</h5>
                                        <p>文件大小: ${formatFileSize(data.size)} (限制: ${formatFileSize(data.max_size)})</p>
                                    </div>
                                    <div class="modal-footer justify-content-center">
                                        <a href="${data.download_url}" class="btn btn-primary" download>
                                            <i class="fas fa-download me-2"></i>下载报告
                                        </a>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    </div>
                                `;
                    } else if (data.status === 'success') {
                        // 成功预览
                        modalBody.innerHTML = `
                                    <div class="modal-header">
                                        <h5 class="modal-title">报告预览 - ${data.filename}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body p-0">
                                        <iframe id="reportPreviewFrame"
                                                srcdoc="${escapeHtml(data.content)}"
                                                style="width:100%; height:80vh; border:none;"></iframe>
                                    </div>
                                    <div class="modal-footer">
                                        <a href="${data.download_url}"
                                           class="btn btn-primary"
                                           download>
                                            <i class="fas fa-download me-2"></i>下载完整报告
                                        </a>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    </div>
                                `;
                    } else {
                        // 其他错误
                        throw new Error(data.message || "未知错误");
                    }
                })
                .catch(error => {
                    console.error('预览错误:', error);
                    modalBody.innerHTML = `
                                <div class="modal-header">
                                    <h5 class="modal-title">预览失败</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        ${escapeHtml(error.message)}
                                    </div>·
                                    <div class="text-center mt-3">
                                        <a href="${data.download_url}"
                                           class="btn btn-primary"
                                           download>
                                            <i class="fas fa-download me-2"></i>尝试下载报告
                                        </a>
                                    </div>
                                </div>
                            `;
                });
        });
    });

    // HTML转义函数
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // 初始化工具提示
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });


    // 安全设置iframe内容
    function setIframeContent(iframe, content) {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        doc.open();
        doc.write(content);
        doc.close();
    }

    // 显示历史记录弹窗
    // document.getElementById("showHistoryBtn").addEventListener("click", function() {
    //     fetch(`{{ url_for('analysis_history') }}`)
    //         .then(response => response.json())
    //         .then(data => {
    //             const historyList = document.getElementById("historyList");
    //             historyList.innerHTML = "";
    //
    //             if (data.length === 0) {
    //                 historyList.innerHTML = "<p>暂无历史记录</p>";
    //             } else {
    //                 data.forEach((item, index) => {
    //                     const recordDiv = document.createElement("div");
    //                     recordDiv.innerHTML = `
    //                         <h4>记录 ${index + 1}</h4>
    //                         <p>时间: ${item.timestamp || "未知"}</p>
    //                         <p>文件: ${item.filename || "未知"}</p>
    //                         <pre>${JSON.stringify(item.data, null, 2)}</pre>
    //                         <hr>
    //                     `;
    //                     historyList.appendChild(recordDiv);
    //                 });
    //             }
    //
    //             document.getElementById("historyModal").style.display = "block";
    //         });
    // });

    // 关闭弹窗
    document.getElementById("closeHistoryBtn").addEventListener("click", function () {
        document.getElementById("historyModal").style.display = "none";
    });



    function loadHistory() {
        fetch(`{{ url_for('analysis_history') }}`,{
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Device-ID': X_Device_ID,  // 你的获取设备ID逻辑
                },
            })
            .then(response => response.json())
            .then(data => {
                const historyList = document.getElementById("historyList");
                historyList.innerHTML = "";

                if (data.length === 0) {
                    historyList.innerHTML = `<div class="text-center py-3 text-muted">暂无历史记录</div>`;
                } else {
                    data['batches'].forEach((item, index) => {
                        const itemElement = document.createElement("a");
                        itemElement.className = "list-group-item list-group-item-action history-item";
                        itemElement.innerHTML = `
                                    <div class="d-flex justify-content-between">
                                        <strong>记录 #${index + 1}</strong>
                                        <small class="text-muted">${item.start_time} - ${item.end_time}</small>
                                    </div>
                                    <div class="row">
                                        <div class="col">id: ${item.id}</div>
                                        <div class="col">batch_id: ${item.batch_id}</div>
                                    </div>
                                    <div class="row">
                                        <div class="col">status: ${item.status}</div>
                                        <div class="col">total_files: ${item.total_files}</div>
                                        <div class="col">total_warnings: ${item.total_warnings}</div>
                                        <div class="col">total_errors: ${item.total_errors}</div>
                                    </div>
                                `;
                        itemElement.addEventListener("click", () => showPreview(item));
                        historyList.appendChild(itemElement);
                    });
                }

                // 显示模态框
                document.getElementById("historyModal").style.display = "block";
            });
    }

    // 显示预览
    function showPreview(item) {
        document.getElementById("previewTitle").textContent =
            `batch_id: ${item.batch_id} | 时间: ${item.start_time} - ${item.end_time} | 状态: status: ${item.status} `;
        document.getElementById("totalWarnings").textContent = `${item.total_warnings} `;
        document.getElementById("totalErrors").textContent = `${item.total_errors} `;

        // Initial load
        updatePreviewContent(item);
        // Add event listeners for checkboxes
        document.getElementById("showWarnings").addEventListener('change', () => updatePreviewContent(item));
        document.getElementById("showErrors").addEventListener('change', () => updatePreviewContent(item));
        document.getElementById("showHistoryDetailBtn").addEventListener("click", () => updatePreviewContent(item));

        document.getElementById("previewModal").style.display = "block";
    }

    document.getElementById("closepreviewModal").addEventListener("click", function () {
        document.getElementById("previewModal").style.display = "none";
    });


    function updatePreviewContent(item) {
        // 显示加载状态
        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center" style="height: 300px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-3">正在加载日志数据...</span>
                    </div>
                `;

        // 模拟异步加载（实际应用中替换为真实的AJAX请求）
        setTimeout(() => {
            // 实际数据处理逻辑
            renderPreviewContent(item);
        }, 800);
    }

    async function renderPreviewContent(item) {
        // Fetch detailed data
        const response = await fetch(`/get_log_details?batch_id=${item.batch_id}&file_id=${item.file_id}`);
        const data = await response.json();

        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = `
        <ul class="nav nav-tabs" id="logTabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors" type="button" role="tab">Errors (<span class="error-count">0</span>) </button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="exceptions-tab" data-bs-toggle="tab" data-bs-target="#exceptions" type="button" role="tab">Exceptions (<span class="exception-count">0</span>) </button></li>
        </ul>
            <div class="tab-content p-3 border border-top-0 rounded-bottom">
                    <div class="tab-pane fade show active" id="errors" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>line</th>
                                        <th>Message</th>
                                        <th>Source</th>
                                    </tr>
                                </thead>
                                <tbody id="errorTableBody">
                                </tbody>
                            </table>
                            <div id="errorPagination" class="d-flex justify-content-end mt-3"></div>
                        </div>
                    </div>
                        <div class="tab-pane fade" id="exceptions" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>line</th>
                                            <th>Type</th>
                                            <th>Details</th>
                                            <th>Source</th>
                                        </tr>
                                    </thead>
                                    <tbody id="exceptionTableBody">
                                    </tbody>
                                </table>
                                <div id="exceptionPagination" class="d-flex justify-content-end mt-3"></div>
                            </div>
                        </div>
            </div>
        `;

        // 填充数据
        populateErrorTable(data.errors);
        populateExceptionTable(data.exceptions);

        // 初始化分页
        initExceptionPagination(data.exceptions);
        initErrorPagination(data.errors);
        }

    function populateExceptionTable(exceptions, page = 1) {
        const tableBody = document.getElementById('exceptionTableBody');
        tableBody.innerHTML = '';

        const startIndex = (page - 1) * paginationConfig.pageSize;
        const endIndex = startIndex + paginationConfig.pageSize;
        const paginatedData = exceptions.slice(startIndex, endIndex);

        // 更新异常计数
        document.querySelector('.exception-count').textContent = exceptions.length;

        // 填充表格数据
        paginatedData.forEach(exception => {
            const row = document.createElement('tr');
            row.innerHTML = `
                        <td>${exception.line_number}</td>
                        <td>${exception.type}</td>
                        <td>${exception.message}</td>
                        <td>${exception.source}</td>
                    `;
            tableBody.appendChild(row);
        });
        scrollTableToTop();
    }

    // 滚动表格到顶部
    function scrollTableToTop() {
        const tableContainer = document.querySelector('.table'); // 替换成你的表格容器选择器
        if (tableContainer) {
            tableContainer.scrollTop = 0; // 设置滚动位置为顶部
        }
    }

    function initExceptionPagination(exceptions) {
        const totalPages = Math.ceil(exceptions.length / paginationConfig.pageSize);
        const paginationContainer = document.getElementById('exceptionPagination');

        // 计算当前页的起始和结束索引
        const startIndex = (paginationConfig.currentPage - 1) * paginationConfig.pageSize;
        const endIndex = Math.min(startIndex + paginationConfig.pageSize, exceptions.length);

        if (totalPages <= 1) {
            paginationContainer.innerHTML = '';
            return;
        }

        let paginationHTML = `
                    <nav aria-label="Exceptions pagination">
                        <ul class="pagination pagination-sm">
                            <li class="page-item ${paginationConfig.currentPage === 1 ? 'disabled' : ''}">
                                <a class="page-link" href="#" aria-label="Previous" id="prevPage">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                `;

        // 显示页码 - 最多显示5个页码
        const maxVisiblePages = 5;
        let startPage = Math.max(1, paginationConfig.currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // 调整如果接近开头或结尾
        if (endPage - startPage + 1 < maxVisiblePages) {
            if (paginationConfig.currentPage < totalPages / 2) {
                endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            } else {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
        }

        // 第一页
        if (startPage > 1) {
            paginationHTML += `
                        <li class="page-item">
                            <a class="page-link page-number" href="#" data-page="1">1</a>
                        </li>
                        ${startPage > 2 ? '<li class="page-item disabled"><span class="page-link">...</span></li>' : ''}
                    `;
        }

        // 中间页码
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                        <li class="page-item ${i === paginationConfig.currentPage ? 'active' : ''}">
                            <a class="page-link page-number" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
        }

        // 最后一页
        if (endPage < totalPages) {
            paginationHTML += `
                        ${endPage < totalPages - 1 ? '<li class="page-item disabled"><span class="page-link">...</span></li>' : ''}
                        <li class="page-item">
                            <a class="page-link page-number" href="#" data-page="${totalPages}">${totalPages}</a>
                        </li>
                    `;
        }

        paginationHTML += `
                            <li class="page-item ${paginationConfig.currentPage === totalPages ? 'disabled' : ''}">
                                <a class="page-link" href="#" aria-label="Next" id="nextPage">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    <div class="ms-3 align-self-center" style="padding-top: 22px;font-size: 12px;">
                        <p>显示 ${startIndex + 1}-${endIndex} 条，共 ${exceptions.length} 条</p>
                    </div>
                `;

        paginationContainer.innerHTML = paginationHTML;

        // 事件委托处理分页点击
        paginationContainer.addEventListener('click', (e) => {
            e.preventDefault();

            if (e.target.closest('#prevPage')) {
                if (paginationConfig.currentPage > 1) {
                    paginationConfig.currentPage--;
                    updateExceptionDisplay(exceptions);
                }
            } else if (e.target.closest('#nextPage')) {
                if (paginationConfig.currentPage < totalPages) {
                    paginationConfig.currentPage++;
                    updateExceptionDisplay(exceptions);
                }
            } else if (e.target.closest('.page-number')) {
                const page = parseInt(e.target.dataset.page);
                if (!isNaN(page) && page !== paginationConfig.currentPage) {
                    paginationConfig.currentPage = page;
                    updateExceptionDisplay(exceptions);
                }
            }
        });

    }

    /**
     * init the error table with log data
     * @param exceptions
     */
    function initErrorPagination(errors) {
        const totalPages = Math.ceil(errors.length / paginationConfig.pageSize);
        const paginationContainer = document.getElementById('errorPagination');

        // 计算当前页的起始和结束索引
        const startIndex = (paginationConfig.currentPage - 1) * paginationConfig.pageSize;
        const endIndex = Math.min(startIndex + paginationConfig.pageSize, errors.length);

        if (totalPages <= 1) {
            paginationContainer.innerHTML = '';
            return;
        }

        let paginationHTML = `
                    <nav aria-label="Exceptions pagination">
                        <ul class="pagination pagination-sm">
                            <li class="page-item ${paginationConfig.currentPage === 1 ? 'disabled' : ''}">
                                <a class="page-link" href="#" aria-label="Previous" id="prevPage">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                `;

        // 显示页码 - 最多显示5个页码
        const maxVisiblePages = 5;
        let startPage = Math.max(1, paginationConfig.currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // 调整如果接近开头或结尾
        if (endPage - startPage + 1 < maxVisiblePages) {
            if (paginationConfig.currentPage < totalPages / 2) {
                endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            } else {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
        }

        // 第一页
        if (startPage > 1) {
            paginationHTML += `
                        <li class="page-item">
                            <a class="page-link page-number" href="#" data-page="1">1</a>
                        </li>
                        ${startPage > 2 ? '<li class="page-item disabled"><span class="page-link">...</span></li>' : ''}
                    `;
        }

        // 中间页码
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                        <li class="page-item ${i === paginationConfig.currentPage ? 'active' : ''}">
                            <a class="page-link page-number" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
        }

        // 最后一页
        if (endPage < totalPages) {
            paginationHTML += `
                        ${endPage < totalPages - 1 ? '<li class="page-item disabled"><span class="page-link">...</span></li>' : ''}
                        <li class="page-item">
                            <a class="page-link page-number" href="#" data-page="${totalPages}">${totalPages}</a>
                        </li>
                    `;
        }

        paginationHTML += `
                            <li class="page-item ${paginationConfig.currentPage === totalPages ? 'disabled' : ''}">
                                <a class="page-link" href="#" aria-label="Next" id="nextPage">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    <div class="ms-3 align-self-center" style="padding-top: 22px;font-size: 12px;">
                        <p>显示 ${startIndex + 1}-${endIndex} 条，共 ${exceptions.length} 条</p>
                    </div>
                `;

        paginationContainer.innerHTML = paginationHTML;

        // 事件委托处理分页点击
        paginationContainer.addEventListener('click', (e) => {
            e.preventDefault();

            if (e.target.closest('#prevPage')) {
                if (paginationConfig.currentPage > 1) {
                    paginationConfig.currentPage--;
                    updateErrorDisplay(errors);
                }
            } else if (e.target.closest('#nextPage')) {
                if (paginationConfig.currentPage < totalPages) {
                    paginationConfig.currentPage++;
                    updateErrorDisplay(errors);
                }
            } else if (e.target.closest('.page-number')) {
                const page = parseInt(e.target.dataset.page);
                if (!isNaN(page) && page !== paginationConfig.currentPage) {
                    paginationConfig.currentPage = page;
                    updateErrorDisplay(errors);
                }
            }
        });
        paginationContainer1.addEventListener('click', (e) => {
            e.preventDefault();

            if (e.target.closest('#prevPage')) {
                if (paginationConfig.currentPage > 1) {
                    paginationConfig.currentPage--;
                    updateErrorDisplay(errors);
                }
            } else if (e.target.closest('#nextPage')) {
                if (paginationConfig.currentPage < totalPages) {
                    paginationConfig.currentPage++;
                    updateErrorDisplay(errors);
                }
            } else if (e.target.closest('.page-number')) {
                const page = parseInt(e.target.dataset.page);
                if (!isNaN(page) && page !== paginationConfig.currentPage) {
                    paginationConfig.currentPage = page;
                    updateErrorDisplay(errors);
                }
            }
        });
    }

    // 统一更新显示的辅助函数
    function updateExceptionDisplay(exceptions) {
        populateExceptionTable(exceptions, paginationConfig.currentPage);
        initExceptionPagination(exceptions); // 重新渲染分页控件
    }

    function updateErrorDisplay(errors) {
        populateErrorTable(errors, paginationConfig.currentPage);
        initErrorPagination(errors); // 重新渲染分页控件
    }

    /**
     * Populates the error table with log data
     * @param {Array} errors - Array of error objects
     * @param page
     */
    function populateErrorTable(errors, page = 1) {
        const tableBody = document.getElementById('errorTableBody');
        tableBody.innerHTML = '';

        const startIndex = (page - 1) * paginationConfig.pageSize;
        const endIndex = startIndex + paginationConfig.pageSize;
        const paginatedData = errors.slice(startIndex, endIndex);

        try {
            // 更新错误计数
            document.querySelector('.error-count').textContent = errors.length;

            paginatedData.forEach(error => {
                const row = document.createElement('tr');
                row.innerHTML = `
                            <td>${error.line_number}</td>
                            <td>${error.message}</td>
                            <td>${error.source}</td>

                        `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Error populating error table:', error);
            tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-danger">
                                Failed to load error data. Please try again.
                            </td>
                        </tr>
                    `;
        }
        scrollTableToTop();
    }

    /**
     * Sets up filtering functionality for the error table
     */
    function setupErrorFilters() {
        const showWarningsCheckbox = document.getElementById('showWarnings');
        const showErrorsCheckbox = document.getElementById('showErrors');

        function applyFilters() {
            const showWarnings = showWarningsCheckbox.checked;
            const showErrors = showErrorsCheckbox.checked;

            document.querySelectorAll('#errorTableBody tr').forEach(row => {
                const severity = row.dataset.severity;
                const isVisible =
                    (severity === 'warning' && showWarnings) ||
                    (severity !== 'warning' && showErrors);

                row.style.display = isVisible ? '' : 'none';
            });
        }

        // Add event listeners
        showWarningsCheckbox.addEventListener('change', applyFilters);
        showErrorsCheckbox.addEventListener('change', applyFilters);

        // Apply initial filters
        applyFilters();
    }

    // Helper function to format dates consistently
    function formatDate(dateString) {
        if (!dateString) return 'Unknown';

        try {
            const date = new Date(dateString);
            return isNaN(date.getTime())
                ? 'Invalid date'
                : date.toLocaleString();
        } catch (e) {
            return 'Invalid date';
        }
    }

    function showExceptionDetail(stacktrace) {
        // Implement a modal to show full stack trace
        console.log(stacktrace);
        // Example using Bootstrap modal:
        $('#exceptionDetailModal .modal-body').text(stacktrace);
        $('#exceptionDetailModal').modal('show');
    }

    function loadPage(page) {
        const searchText = document.getElementById('searchInput').value;
        const filterType = document.getElementById('filterType').value;

        fetch(`/?page=${page}&search=${encodeURIComponent(searchText)}&type=${filterType}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('reportList').innerHTML =
                    new DOMParser().parseFromString(html, 'text/html')
                        .getElementById('reportList').innerHTML;
            });
    }


    // 保存用户选择的每页显示数量
    document.getElementById('perPageSelect').addEventListener('change', function () {
        localStorage.setItem('reportsPerPage', this.value);
        window.location.href = `/?page=1&per_page=${this.value}`;
    });


    // 跳转到指定页码
    function jumpToPage() {
        // 显示加载动画
        // document.getElementById('loading').style.display = 'block';

        const pageInput = document.getElementById('pageJump');
        let page = parseInt(pageInput.value);
        const totalPages = parseInt("{{ total_pages }}");

        // 验证输入
        if (isNaN(page) || page < 1) {
            page = 1;
        } else if (page > totalPages) {
            page = totalPages;
        }

        // 获取当前搜索和过滤参数
        const searchText = document.getElementById('searchInput').value;
        const filterType = document.getElementById('filterType').value;

        // 构建查询参数
        const params = new URLSearchParams();
        params.append('page', page);
        if (searchText) params.append('search', searchText);
        if (filterType !== 'all') params.append('type', filterType);

        // 跳转到指定页
        window.location.href = `/?${params.toString()}`;
    }

    // 处理回车键
    function handlePageJumpKeyPress(event) {
        if (event.key === 'Enter') {
            jumpToPage();
        }
    }

    // 初始化时限制输入范围
    pageJump.addEventListener('change', function () {
        const totalPages = parseInt("{{ total_pages }}");
        let page = parseInt(this.value);

        if (isNaN(page) || page < 1) {
            this.value = 1;
        } else if (page > totalPages) {
            this.value = totalPages;
        }
    });


    // 添加全局键盘监听
    // document.addEventListener('keydown', function(event) {
    //     if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'TEXTAREA') {
    //         if (event.key === 'ArrowLeft' && {{ page }} > 1) {
    //             window.location.href = `?page={{ page - 1 }}`;
    //         } else if (event.key === 'ArrowRight' && {{ page }} < {{ total_pages }}) {
    //             window.location.href = `?page={{ page + 1 }}`;
    //         }
    //     }
    // });

</script>
{% endblock %}
{% endblock %}