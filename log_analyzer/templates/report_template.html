<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <title>日志分析报告 - {{ report_time }}</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
            h1 { color: #333; }
            h2 { color: #444; }
            h3 { color: #555; }
            table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .plot { margin: 20px 0; }

            /* 异常分类卡片网格布局 */
            .exception-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            /* 异常卡片样式 */
            .exception-card {
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 15px;
                background-color: #fff;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .exception-card:hover {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transform: translateY(-2px);
            }

            /* 异常卡片头部 */
            .exception-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }

            .exception-title {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .exception-icon {
                font-size: 1.2em;
            }

            .exception-count {
                background-color: #ff6b6b;
                color: white;
                padding: 3px 10px;
                border-radius: 12px;
                font-size: 0.9em;
                font-weight: bold;
            }

            /* 异常时间线 */
            .exception-timeline {
                margin: 10px 0;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 6px;
            }

            .timeline-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }

            .timeline-label {
                font-weight: bold;
                color: #555;
            }

            .timeline-value {
                color: #333;
            }

            /* 异常详情（默认隐藏） */
            .exception-details {
                max-height: 0;
                overflow: auto;
                transition: max-height 0.3s ease;
                margin-top: 10px;
            }

            .exception-details.active {
                max-height: 500px;
                overflow: auto;
            }

            /* 更多记录提示 */
            .more-records {
                text-align: center;
                color: #666;
                font-style: italic;
                margin-top: 10px;
            }

            /* 全局搜索样式 */
            .global-search {
                background-color: #e9f7ef;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 20px;
            }
            .search-controls {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }
            .search-input {
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .search-btn {
                padding: 8px 15px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .search-results {
                max-height: 500px;
                overflow-y: auto;
                margin-top: 15px;
            }

            /* Tab样式 */
            .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; }
            .tab button {
                background-color: inherit;
                float: left;
                border: none;
                outline: none;
                cursor: pointer;
                padding: 10px 16px;
                transition: 0.3s;
                font-size: 14px;
            }
            .tab button:hover { background-color: #ddd; }
            .tab button.active { background-color: #4CAF50; color: white; }
            .tabcontent { display: none; padding: 6px 12px; border: 1px solid #ccc; overflow: auto; border-top: none; }
            .tabcontent.active { display: block; overflow: auto;  }

            /* 过滤控件样式 */
            .filter-controls {
                background-color: #f8f9fa;
                padding: 15px;
                margin-bottom: 20px;
                border-radius: 5px;
            }
            .filter-group { margin-bottom: 10px; }
            .filter-label { display: inline-block; width: 100px; font-weight: bold; }
            .filter-select {
                padding: 5px;
                min-width: 200px;
                border-radius: 4px;
                border: 1px solid #ddd;
            }
            .filter-btn {
                padding: 5px 15px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .filter-btn:hover { background-color: #45a049; }

            /* 分页样式 */
            .pagination { margin: 15px 0; display: flex; justify-content: center; }
            .page-btn {
                padding: 5px 10px;
                margin: 0 5px;
                cursor: pointer;
                border: 1px solid #ddd;
                background: #f8f8f8;
                border-radius: 3px;
            }
            .page-btn.active { background: #4CAF50; color: white; }
            .page-btn:hover:not(.active) { background-color: #ddd; }
            .page-info { margin: 0 10px; line-height: 30px; }

            /* 文件摘要卡片 */
            .file-summary {
                background-color: #f8f9fa;
                border-radius: 5px;
                padding: 15px;
                margin-bottom: 15px;
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }
            .summary-item { padding: 5px; }
            .summary-label { font-weight: bold; color: #555; }

            /* 高亮匹配行 */
            .highlight { background-color: #fffacd; }
        </style>
        <script src="{{ url_for('static', filename='js/plotly-basic.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
    </head>
    <body>
        <h2>日志分析综合报告</h2>
        <p>生成时间: {{ report_time }}</p>
        <!-- 异常分类概览 -->
        <div class="section">
            <h3>异常类型统计</h3>
            <div class="plot">
                <canvas id="exceptionChart" width="800" height="200"></canvas>
            </div>

            <!-- 异常分类卡片展示 -->
            <div class="exception-grid">
                {% for exc_type, count in merged_results.exception_counts.items() %}
                <div class="exception-card" onclick="toggleExceptionDetails(event, '{{ exc_type}}')">
                    <div class="exception-header">
                        <div class="exception-title">
                            <span class="exception-icon">⚠️</span>
                            <h4>{{ exc_type }}</h4>
                        </div>
                        <span class="exception-count">{{ count }} 次</span>
                    </div>

                    <div class="exception-timeline">
                        <div class="timeline-item">
                            <span class="timeline-label">首次出现</span>
                            <span class="timeline-value">{{ merged_results.exception_first_occurrence.get(exc_type, '未知') }}</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">最后出现</span>
                            <span class="timeline-value">{{ merged_results.exception_last_occurrence.get(exc_type, '未知') }}</span>
                        </div>
                    </div>

                    <!-- 异常详情（默认折叠） -->
                    <div id="details-{{ exc_type }}" class="exception-details">
                        <table>
                            <thead>
                                <tr>
                                    <th>文件</th>
                                    <th>行号</th>
                                    <th>时间</th>
                                    <th>详情</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for error in merged_results.exception_details.get(exc_type, [])[:5] %}
                                <tr>
                                    <td>{{ error.source_file }}</td>
                                    <td>{{ error.line_number }}</td>
                                    <td>{{ error.time }}</td>
                                    <td>{{ error.message }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if merged_results.exception_details.get(exc_type, [])|length > 5 %}
                        <p class="more-records">... 更多 {{ merged_results.exception_details.get(exc_type, [])|length - 5 }} 条记录</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 全局搜索 -->
        <div class="section">
            <h2>全局错误搜索</h2>
            <div class="global-search">
                <div class="search-controls">
                    <input type="text" id="global-search-input" class="search-input" placeholder="输入关键词或异常类型...">
                    <button class="search-btn" onclick="performGlobalSearch()">搜索</button>
                </div>
                <div>
                    <label>搜索范围:</label>
                    <select id="search-scope">
                        <option value="all">所有内容</option>
                        <option value="message">错误消息</option>
                        <option value="exception">异常类型</option>
                    </select>
                </div>
                <div class="search-results" id="global-search-results">
                    <!-- 搜索结果将在这里显示 -->
                </div>
            </div>
        </div>

        <div class="section">
            <h2>文件详细分析</h2>

            <!-- Tab导航 -->
            <div class="tab">
                {% for file in file_results %}
                <button class="tablinks {% if loop.first %}active{% endif %}"
                        onclick="openTab(event, '{{ file.filename|replace('.', '_') }}')">
                    {{ file.filename }} ({{ file.stats.errors }} errors)
                </button>
                {% endfor %}
            </div>

            <!-- Tab内容 -->
            {% for file in file_results %}
            <div id="{{ file.filename|replace('.', '_') }}" class="tabcontent {% if loop.first %}active{% endif %}">
                <h3>{{ file.filename }}</h3>

                <!-- 过滤控件 -->
                <div class="filter-controls">
                    <div class="filter-group">
                        <span class="filter-label">关键词筛选:</span>
                        <select id="keyword-filter-{{ loop.index }}" class="filter-select" multiple>
                            {% for kw in all_keywords %}
                            <option value="{{ kw }}" selected>{{ kw }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">时间范围:</span>
                        <input type="text" id="time-start-{{ loop.index }}" class="filter-select" placeholder="开始时间">
                        <input type="text" id="time-end-{{ loop.index }}" class="filter-select" placeholder="结束时间">
                    </div>
                    <button class="filter-btn" onclick="applyFilters({{ loop.index }})">应用筛选</button>
                    <button class="filter-btn" onclick="resetFilters({{ loop.index }})">重置筛选</button>
                </div>

                <div class="file-summary">
                    <div class="summary-item">
                        <span class="summary-label">总行数:</span>
                        <span>{{ "{:,}".format(file.stats.lines) }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">错误数:</span>
                        <span>{{ file.stats.errors }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">警告数:</span>
                        <span>{{ file.stats.warnings }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">关键词匹配:</span>
                        <span>{{ file.stats.keywords }}</span>
                    </div>
                </div>

                <h4>错误时间分布</h4>
                <div class="plot">
                    {{ file.time_plot }}
                </div>

                <h4>错误详情</h4>
                <div class="pagination" id="pagination-{{ loop.index }}">
                    <select id="rows-per-page" onchange="changeRowsPerPage(this.value)">
                        <option value="500">500 行/页</option>
                        <option value="1000" selected >1000 行/页</option>
                        <option value="2000">2000 行/页</option>
                        <option value="3000">3000 行/页</option>
                        <option value="5000">5000 行/页</option>
                        <option value="10000">10000 行/页</option>
                    </select>
                    <button class="page-btn" onclick="prevPage({{ loop.index }})">&laquo; 上一页</button>
                    <span class="page-info" id="page-info-{{ loop.index }}">
                        第 <span id="current-page-{{ loop.index }}">1</span> 页 / 共 <span id="total-pages-{{ loop.index }}">1</span> 页
                        (共 <span id="total-items-{{ loop.index }}">{{ file.error_details|length }}</span> 条记录)
                    </span>
                    <button class="page-btn" onclick="nextPage({{ loop.index }})">下一页 &raquo;</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>行号</th>
                            <th>时间</th>
                            <th>关键词</th>
                            <th>详情</th>
                        </tr>
                    </thead>
                    <tbody id="error-table-{{ loop.index }}">
                        {% for error in file.error_details[MAX_ERROR_DETAILS] %}
                        <tr>
                            <td>{{ error.line_number }}</td>
                            <td>{{ error.time }}</td>
                            <td>{{ error.keyword }}</td>
                            <td>{{ error.message }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="pagination" id="pagination-{{ loop.index }}">
                <select id="rows-per-page1" onchange="changeRowsPerPage(this.value)">
                    <option value="500">500 行/页</option>
                    <option value="1000" selected>1000 行/页</option>
                    <option value="2000">2000 行/页</option>
                    <option value="3000">3000 行/页</option>
                    <option value="5000">5000 行/页</option>
                    <option value="10000">10000 行/页</option>
                </select>
                    <button class="page-btn" onclick="prevPage({{ loop.index }})">&laquo; 上一页</button>
                    <span class="page-info" id="page-info-{{ loop.index }}">
                        第 <span id="current-page1-{{ loop.index }}">1</span> 页 / 共 <span id="total-pages1-{{ loop.index }}">1</span> 页
                        (共 <span id="total-items1-{{ loop.index }}">{{ file.error_details|length }}</span> 条记录)
                    </span>
                    <button class="page-btn" onclick="nextPage({{ loop.index }})">下一页 &raquo;</button>
                </div>
                <!-- 隐藏的完整数据 -->
                <div id="error-data-{{ loop.index }}" style="display:none;">
                    {{ file.error_details|tojson }}
                </div>
            </div>
            {% endfor %}
        </div>

    </body>
 <script>

    // 全局变量
    let itemsPerPage = {{ MAX_ERROR_DETAILS }};
    let currentPages = {};
    // 标签页切换时更新当前索引
    let currentTabIndex = 1;
    const currentFilters = {};

    // 新增目录选择函数
    function selectDirectory() {
        const { ipcRenderer } = require('electron');
        ipcRenderer.send('open-directory-dialog');

        ipcRenderer.on('selected-directory', (event, path) => {
            document.getElementById('log-dir').value = path;
            document.getElementById('dir-status').textContent = `已选择目录: ${path}`;
            document.getElementById('dir-status').style.color = '#4CAF50';
        });
    }

    function startAnalysis() {
        const dirPath = document.getElementById('log-dir').value;
        if (!dirPath) {
            document.getElementById('dir-status').textContent = '请先选择日志目录';
            document.getElementById('dir-status').style.color = '#ff0000';
            return;
        }

        // 显示加载状态
        document.getElementById('dir-status').textContent = '分析中...';

        // 调用后端分析接口
        fetch('/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ directory: dirPath })
        })
        .then(response => response.json())
        .then(data => {
            // 更新页面显示分析结果
            updateAnalysisResults(data);
            document.getElementById('dir-status').textContent = '分析完成';
        })
        .catch(error => {
            document.getElementById('dir-status').textContent = `分析失败: ${error}`;
        });
    }

    // 初始化异常类型图表
    const exceptionCtx = document.getElementById('exceptionChart').getContext('2d');
    const exceptionChart = new Chart(exceptionCtx, {
        type: 'bar',
        data: {
            labels: {{ merged_results.exception_counts.keys()|list|tojson }},
            datasets: [{
                label: '异常出现次数',
                data: {{ merged_results.exception_counts.values()|list|tojson }},
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 显示/隐藏异常详情
    function showExceptionDetails(excType) {
        const detailsDiv = document.getElementById(`details-${excType}`);
        if (detailsDiv.style.display === 'none') {
            detailsDiv.style.display = 'block';
        } else {
            detailsDiv.style.display = 'none';
        }
    }

    // 全局搜索功能
    function performGlobalSearch() {
        const searchTerm = document.getElementById('global-search-input').value.toLowerCase();
        const searchScope = document.getElementById('search-scope').value;
        const resultsContainer = document.getElementById('global-search-results');

        if (!searchTerm) {
            resultsContainer.innerHTML = '<p>请输入搜索关键词</p>';
            return;
        }

        // 从隐藏的全局数据中搜索
        const allErrors = {{ global_errors|tojson }};
        const filteredResults = allErrors.filter(error => {
            if (error.message){
                msg = error.message.toLowerCase();
                if (searchScope === 'all') {
                    return msg.includes(searchTerm)
                } else if (searchScope === 'message') {
                    return msg.includes(searchTerm);
                } else if (searchScope === 'exception') {
                    if (msg.includes('exception')){
                        return msg.includes(searchTerm);
                    }
                    return false
                }
            }
            return false;
        });

        // 显示搜索结果
        if (filteredResults.length === 0) {
            resultsContainer.innerHTML = '<p>没有找到匹配的结果</p>';
            return;
        }

        let html = `<p>找到 ${filteredResults.length} 条匹配结果:</p>`;
        html += '<table><tr><th>文件</th><th>行号</th><th>时间</th><th>类型</th><th>详情</th></tr>';

        filteredResults.slice(0, 100).forEach(error => {
            html += `
                <tr>
                    <td>${error.source_file}</td>
                    <td>${error.line_number}</td>
                    <td>${error.time}</td>
                    <td>${error.exception}</td>
                    <td>${error.message}</td>
                </tr>
            `;
        });

        html += '</table>';

        if (filteredResults.length > 100) {
            html += `<p>... 更多 ${filteredResults.length - 100} 条结果未显示</p>`;
        }

        resultsContainer.innerHTML = html;
    }




    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化所有Tab的分页
        const tabs = document.getElementsByClassName('tabcontent');
        for (let i = 0; i < tabs.length; i++) {
            if (tabs[i].classList.contains('active')) {
                resetPagination(i + 1);
            }
        }

        // 初始化多选下拉框
        const selects = document.querySelectorAll('.filter-select[multiple]');
        selects.forEach(select => {
            new MultiSelect(select, {
                enableSearch: true,
                searchPlaceholder: '搜索关键词'
            });
        });
    });

    // 切换异常详情显示/隐藏
    function toggleExceptionDetails(event, excType) {
        //event.stopPropagation();  // 阻止冒泡
        const detailsDiv = document.getElementById(`details-${excType}`);
        detailsDiv.classList.toggle('active');
    }


    // Tab切换函数
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;

        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }

        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }

        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");

        // 切换到第一页
        const tabIndex = Array.from(tablinks).indexOf(evt.currentTarget) + 1;
        resetPagination(tabIndex);

        // 更新当前标签页索引
        currentTabIndex = Array.from(document.querySelectorAll('.tablinks')).indexOf(evt.currentTarget) + 1;
    }

    // 应用筛选条件
    function applyFilters(tabIndex) {
        const keywordSelect = document.getElementById(`keyword-filter-${tabIndex}`);
        const timeStart = document.getElementById(`time-start-${tabIndex}`).value;
        const timeEnd = document.getElementById(`time-end-${tabIndex}`).value;

        // 获取选中的关键词
        const selectedKeywords = Array.from(keywordSelect.selectedOptions)
            .map(opt => opt.value);

        // 保存当前筛选条件
        currentFilters[tabIndex] = {
            keywords: selectedKeywords,
            timeStart: timeStart,
            timeEnd: timeEnd
        };

        // 重置分页并更新显示
        resetPagination(tabIndex);
    }

    // 重置筛选条件
    function resetFilters(tabIndex) {
        const keywordSelect = document.getElementById(`keyword-filter-${tabIndex}`);
        const timeStart = document.getElementById(`time-start-${tabIndex}`);
        const timeEnd = document.getElementById(`time-end-${tabIndex}`);

        // 重置所有选项为选中
        Array.from(keywordSelect.options).forEach(opt => {
            opt.selected = true;
        });

        // 清空时间范围
        timeStart.value = '';
        timeEnd.value = '';

        // 清除筛选条件
        currentFilters[tabIndex] = null;

        // 重置分页
        resetPagination(tabIndex);
    }

    // 筛选数据
    function filterData(tabIndex) {
        const allData = JSON.parse(document.getElementById(`error-data-${tabIndex}`).textContent);
        const filter = currentFilters[tabIndex];

        if (!filter) {
            return allData;
        }

        return allData.filter(item => {
            // 关键词筛选
            if (filter.keywords && filter.keywords.length > 0 &&
                !filter.keywords.includes(item.keyword)) {
                return false;
            }

            // 时间范围筛选
            if (filter.timeStart && item.time < filter.timeStart) {
                return false;
            }

            if (filter.timeEnd && item.time > filter.timeEnd) {
                return false;
            }

            return true;
        });
    }

    // 动态修改每页行数
    function changeRowsPerPage(rows) {
        itemsPerPage = parseInt(rows);
        updatePage(currentTabIndex);  // 重新渲染当前页

        // 直接设置selected属性，避免遍历所有option
        const select1 = document.getElementById('rows-per-page1');
        select1.value = itemsPerPage.toString();
        const select = document.getElementById('rows-per-page');
        select.value = itemsPerPage.toString();
    }

    // 分页功能
    function resetPagination(tabIndex) {
        currentPages[tabIndex] = 1;
        updatePage(tabIndex);
    }

    function prevPage(tabIndex) {
        if (currentPages[tabIndex] > 1) {
            currentPages[tabIndex]--;
            updatePage(tabIndex);
        }
    }

    function nextPage(tabIndex) {
        const filteredData = filterData(tabIndex);
        const maxPage = Math.ceil(filteredData.length / itemsPerPage);

        if (currentPages[tabIndex] < maxPage) {
            currentPages[tabIndex]++;
            updatePage(tabIndex);
        }
    }

    function updatePage(tabIndex) {
        const filteredData = filterData(tabIndex);
        const totalItems = filteredData.length;
        const maxPage = Math.ceil(totalItems / itemsPerPage);

        const start = (currentPages[tabIndex] - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageData = filteredData.slice(start, end);

        // 更新表格
        const tableBody = document.getElementById(`error-table-${tabIndex}`);
        tableBody.innerHTML = '';

        pageData.forEach(error => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${error.line_number}</td>
                <td>${error.time}</td>
                <td>${error.keyword}</td>
                <td>${error.message}</td>
            `;
            tableBody.appendChild(row);
        });

        // 更新页码信息
        document.getElementById(`current-page-${tabIndex}`).textContent = currentPages[tabIndex];
        document.getElementById(`total-pages-${tabIndex}`).textContent = maxPage;
        document.getElementById(`total-pages1-${tabIndex}`).textContent = maxPage;
        document.getElementById(`total-items-${tabIndex}`).textContent = totalItems;
        document.getElementById(`total-items1-${tabIndex}`).textContent = totalItems;

        // 高亮匹配的关键词
        highlightKeywords(tabIndex);
    }

    // 高亮关键词
    function highlightKeywords(tabIndex) {
        const filter = currentFilters[tabIndex];
        if (!filter || !filter.keywords || filter.keywords.length === 0) {
            return;
        }

        const tableBody = document.getElementById(`error-table-${tabIndex}`);
        const rows = tableBody.getElementsByTagName('tr');

        for (let row of rows) {
            const keywordCell = row.cells[2];
            const keyword = keywordCell.textContent;

            if (filter.keywords.includes(keyword)) {
                row.classList.add('highlight');
            } else {
                row.classList.remove('highlight');
            }
        }
    }

    // 简单的多选组件
    class MultiSelect {
        constructor(selectElement, options) {
            this.select = selectElement;
            this.options = options || {};
            this.init();
        }

        init() {
            // 创建容器
            this.container = document.createElement('div');
            this.container.className = 'multi-select-container';
            this.select.parentNode.insertBefore(this.container, this.select);
            this.select.style.display = 'none';

            // 创建搜索框
            if (this.options.enableSearch) {
                this.searchInput = document.createElement('input');
                this.searchInput.type = 'text';
                this.searchInput.placeholder = this.options.searchPlaceholder || 'Search...';
                this.searchInput.className = 'multi-select-search';
                this.container.appendChild(this.searchInput);

                this.searchInput.addEventListener('input', () => {
                    this.filterOptions(this.searchInput.value.toLowerCase());
                });
            }

            // 创建选项列表
            this.optionsList = document.createElement('div');
            this.optionsList.className = 'multi-select-options';
            this.container.appendChild(this.optionsList);

            // 初始化选项
            this.renderOptions();
        }

        renderOptions() {
            this.optionsList.innerHTML = '';

            Array.from(this.select.options).forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'multi-select-option';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = option.selected;
                checkbox.id = `option-${option.value}`;

                checkbox.addEventListener('change', () => {
                    option.selected = checkbox.checked;
                });

                const label = document.createElement('label');
                label.htmlFor = `option-${option.value}`;
                label.textContent = option.text;

                optionElement.appendChild(checkbox);
                optionElement.appendChild(label);
                this.optionsList.appendChild(optionElement);
            });
        }

        filterOptions(searchTerm) {
            const options = this.optionsList.getElementsByClassName('multi-select-option');

            Array.from(options).forEach(option => {
                const label = option.getElementsByTagName('label')[0];
                const text = label.textContent.toLowerCase();

                if (text.includes(searchTerm)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }
    }
 </script>
</html>